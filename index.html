
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>wealth-vision-dashboard</title>
    <meta name="description" content="Lovable Generated Project" />
    <meta name="author" content="Lovable" />
    <meta property="og:image" content="/og-image.png" />
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
      var vapiInstance = null;
      const assistant = "9b7aeabf-7e65-401a-a820-ced369981fb9";
      const apiKey = "6efa9f73-a4ea-464e-9fa5-54a7a7eca4f3";
      const buttonConfig = {
        position: 'bottom-left',
        styles: {
          button: {
            backgroundColor: '#ffffff',
            border: '1px solid #e2e8f0',
            borderRadius: '9999px',
            padding: '12px',
            margin: '32px',
            boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
          }
        }
      };

      // Initialize Supabase client
      const supabase = window.supabase.createClient(
        'https://pwnjzbluumgokkuiustn.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3bmp6Ymx1dW1nb2trdWl1c3RuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzk5Nzc3NjAsImV4cCI6MjA1NTU1Mzc2MH0.oJokrIM911gc7wwdNxe8Xt0TwZfF5IMyQ_asMM983NU'
      );

      function initVapi() {
        if (window.location.pathname === '/dashboard') {
          if (!vapiInstance) {
            vapiInstance = window.vapiSDK.run({
              apiKey: apiKey,
              assistant: assistant,
              config: buttonConfig,
              callbacks: {
                onMessage: async (message) => {
                  console.log('Assistant:', message);
                },
                onAssistantReady: async () => {
                  try {
                    // Fetch user data from Supabase
                    const { data: { session } } = await supabase.auth.getSession();
                    const userId = session?.user?.id;
                    
                    if (userId) {
                      const { data: portfolioData } = await supabase
                        .from('portfolios')
                        .select('*, stocks(*)')
                        .eq('user_id', userId)
                        .single();

                      // Update assistant's context with portfolio data
                      if (portfolioData) {
                        vapiInstance.updateContext(`Current portfolio status:
                          - Total Holdings: $${portfolioData.total_holding || 0}
                          - Total Profit: ${portfolioData.total_profit || 0}%
                          - Active Stocks: ${portfolioData.active_stocks || 0}
                          
                          Stocks in portfolio:
                          ${portfolioData.stocks.map(stock => 
                            `- ${stock.symbol}: ${stock.shares} shares @ $${stock.current_price}`
                          ).join('\n')}
                        `);
                      }
                    }
                  } catch (error) {
                    console.error('Error fetching portfolio data:', error);
                  }
                }
              }
            });
          }
        } else if (vapiInstance) {
          // Properly cleanup the Vapi instance
          if (typeof vapiInstance.unmount === 'function') {
            vapiInstance.unmount();
          }
          vapiInstance = null;
        }
      }

      // Initialize Vapi when the script loads
      (function (d, t) {
        var g = document.createElement(t),
          s = d.getElementsByTagName(t)[0];
        g.src =
          "https://cdn.jsdelivr.net/gh/VapiAI/html-script-tag@latest/dist/assets/index.js";
        g.defer = true;
        g.async = true;
        s.parentNode.insertBefore(g, s);

        g.onload = function () {
          initVapi();
          // Listen for route changes
          window.addEventListener('popstate', initVapi);
          // Also listen for React router changes
          window.addEventListener('locationchange', initVapi);
        };
      })(document, "script");

      // Create a custom event listener for React router changes
      let oldPushState = history.pushState;
      history.pushState = function () {
        oldPushState.apply(this, arguments);
        window.dispatchEvent(new Event('locationchange'));
      };
    </script>
  </head>

  <body>
    <div id="root"></div>
    <!-- IMPORTANT: DO NOT REMOVE THIS SCRIPT TAG OR THIS VERY COMMENT! -->
    <script src="https://cdn.gpteng.co/gptengineer.js" type="module"></script>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
